# Kernel Bisection Configuration
# Copy this file to bisect.yaml in your bisection directory and customize
#
# Per-Directory Workflow:
# Each bisection case should have its own directory with:
#   - bisect.yaml (this config file)
#   - bisect.db (database, created automatically)
#
# Example:
#   mkdir ~/bisect-boot-issue
#   cd ~/bisect-boot-issue
#   cp /path/to/bisect.conf.example ./bisect.yaml
#   vim bisect.yaml  # customize
#   kbisect init v6.1 v6.6

# ============================================================================
# MULTI-HOST CONFIGURATION (REQUIRED)
# ============================================================================
# For networking bugs or hardware-specific issues requiring multiple hosts
# Each host can run a different test script (e.g., server vs. client role)
# All hosts must pass their tests for a commit to be marked GOOD
#
# For single-host bisection, simply configure one host in the array

hosts:
  - hostname: 192.168.1.100          # First host (e.g., server or single host)
    ssh_user: root                    # SSH user for this host
    kernel_path: /root/kernel         # Path to kernel source on this host
    bisect_path: /root/kernel-bisect/lib  # Path to bisect library
    test_script: test-server.sh       # Role-specific test script (or test.sh for single host)

    # Power control configuration (per-host)
    # Options: "ipmi", "beaker", or null (SSH reboot fallback)
    # Default: "ipmi" if not specified
    power_control_type: ipmi          # Use IPMI for power control

    # IPMI configuration (required if power_control_type is "ipmi")
    ipmi_host: 192.168.1.101          # IPMI interface for this host
    ipmi_user: admin
    ipmi_password: changeme

  # Example: Second host for multi-host testing (remove if only testing one host)
  # This example shows Beaker power control
  - hostname: server2.example.com    # Second host (e.g., client)
    ssh_user: root
    kernel_path: /root/kernel
    bisect_path: /root/kernel-bisect/lib
    test_script: test-client.sh       # Different test script for client role

    # Use Beaker for power control (requires bkr client installed and Kerberos auth)
    power_control_type: beaker        # Use Beaker lab automation for power control
    # Note: Beaker uses the hostname for system identification
    # Ensure you're authenticated (kinit) before running bisection

# Kernel repository (optional - automatic repository deployment)
# If configured, the repository will be cloned/copied on master and transferred to all hosts
# This eliminates the need to manually clone the kernel source on the hosts
kernel_repo:
  # Git repository URL or local filesystem path
  # Examples:
  #   - https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git
  #   - https://github.com/torvalds/linux.git
  #   - /home/user/local-kernel-repo
  source: null

  # Optional: Branch or ref to checkout after clone
  # If not specified, uses repository's default branch
  # Examples: main, master, linux-6.6.y
  branch: null

# Deployment configuration (automatic host setup)
# Note: Host verification always happens before bisection
deployment:
  auto_deploy: true                  # Automatically deploy to all hosts if not set up

# Timeouts (in seconds)
timeouts:
  boot: 600                          # Boot timeout
  test: 600                          # Test timeout
  build: 3600                        # Build timeout (60 minutes)
  ssh_connect: 30                    # SSH timeout for connection establishment and command execution

# Kernel configuration
kernel_config:
  # Path to base .config file (optional)
  # If not specified, kernel defaults are used
  config_file: null

# Test configuration
# Note: Current kernel is always protected and cannot be deleted during cleanup
# Boot test: Just checks if kernel boots successfully
# Custom test: Runs a custom test script after successful boot
test:
  type: boot                        # "boot" or "custom"
  # If type is "custom", specify script path:
  # script: /root/reproducers/my-test.sh

# State and Database (per-directory isolation)
# All bisection state and metadata stored in SQLite database
database_path: bisect.db            # SQLite database file (default: ./bisect.db)
state_dir: .                        # Working directory for database (default: current directory)

# Metadata collection
# Note: Compression is always enabled for efficient storage
# Note: Package counts are always included in baseline metadata
metadata:
  collect_baseline: true            # Collect system metadata at session start
  collect_per_iteration: true       # Collect kernel metadata per iteration
  collect_kernel_config: true       # Include kernel .config in metadata
  # All metadata stored in database (no filesystem files)

# Console log collection (boot process logs)
console_logs:
  enabled: false                    # Enable console log collection during boot
  collector: "auto"                 # "conserver" | "ipmi" | "auto"
  # Override hostname for console connection (default: first host's hostname)
  hostname: null
  # Fall back to IPMI SOL if conserver fails
  fallback_to_ipmi: true
  # Console logs are stored in database (build_logs table, log_type="console")
  # View with: kbisect logs list --log-type console

# Application Logging
# Logs are printed to terminal (stdout/stderr)
# Use --verbose flag for DEBUG level output: kbisect --verbose start
# Build logs and console logs are stored in the database (see console_logs section above)
